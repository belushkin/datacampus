<!-- Bootstrap core CSS -->
<link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Custom styles for this template -->
<link href="https://getbootstrap.com/docs/4.0/examples/starter-template/starter-template.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" integrity="sha512-3q8fi8M0VS+X/3n64Ndpp6Bit7oXSiyCnzmlx6IDBLGlY5euFySyJ46RUlqIVs0DPCGOypqP8IRk/EyPvU28mQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<div id="clustered-map-box">
  <style type="text/css">
		body {
      padding-top: 4rem;
    }
    #clustered-map-box {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: row;
    }
    #clustered-map,
    #clustered-map-info {
      width: 10%;
      display: inline-block;
    }
    #clustered-map {
      flex-grow: 70;
    }
    #clustered-map-info {
      flex-grow: 30;
    }
    #clustered-map-legend {
      font-family: Arial, sans-serif;
      background: #fff;
      padding: 10px;
      margin: 10px;
      border: 1px solid #000;
      display: none;
    }
    #clustered-map #clustered-map-legend {
      display: block;
    }
		#clustered-map-inner-info {
			height: 70px;
			margin-left: 2rem;
		}
		#clustered-map-inner-filters {
			margin-top: 20rem;
    	margin-left: 2rem;
		}
		.list-group-item {
			border: none;
		}
		.row {
			margin-left: 0;
      margin-right: 0;
		}
    .modal-content {
      margin-top: 50px;
      width: 40rem;
    }
  </style>

  <div id="clustered-map"></div>
  <div id="clustered-map-info">
		<div id="clustered-map-inner-info"></div>
		<div id="clustered-map-inner-filters">
			
			<div class="grid">
				<h4>Можливий напрям використання</h4>
				<div class="row">
					
					<div class="list-group">
						<label class="list-group-item">
							<input class="form-check-input me-1" type="checkbox" value="">
							Комерція
						</label>
						<label class="list-group-item">
							<input class="form-check-input me-1" type="checkbox" value="">
							Офісні приміщення
						</label>
						<label class="list-group-item">
							<input class="form-check-input me-1" type="checkbox" value="">
							Промисловість/склад
						</label>
						<label class="list-group-item">
							<input class="form-check-input me-1" type="checkbox" value="">
							Інше
						</label>
					</div>
				</div>

				<h4 class="mt-4">Відфільтрувати по площі</h4>
				<div class="row mt-3">
					<b>1 м.</b> <input id="ex2" type="text" class="span2" value="" data-slider-min="1" data-slider-max="1000" data-slider-step="5" data-slider-value="[250,450]"/> <b>1000 м.</b>
				</div>
			</div>
      <!-- Modal -->
      <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Сформувати заявку на оренду</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <img src="letter.jpg" />
            </div>
            <div class="modal-footer">
              <div>odesa@spfu.gov.ua</div>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрити</button>
              <button type="button" class="btn btn-primary">Відправити заявку</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="exampleModalCenter2" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Слідкувати за об'єктом</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div class="form-group">
                  Email для запитів: odesa@spfu.gov.ua
                </div>
                <div class="form-group">
                  Telegram канал від Фонду ДержМайна: <a href="#">https://t.me/@FondPropetyBot</a>
                </div>
                <div class="form-group">
                  Телефон: (067) 334 - 34 - 34
                </div>
                <div class="form-group">
                  Статус в системі: <p class="text-success">Опрацьовується</p>
                </div>
                <div class="form-group">
                  <label for="message-text" class="col-form-label">Відправте запит електроним листом:</label>
                  <textarea class="form-control" id="message-text"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрити</button>
              <button type="button" class="btn btn-primary">Відправити</button>
            </div>
          </div>
        </div>
      </div>
		</div>
	</div>

	<div id="clustered-map-legend"><h3>Слои</h3></div>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJmwurVTxlV8Os77L2VymRs_MDzHtJ-FU"
  >
    //тестовый ключ от гугла, который работает только при локальном запуске - AIzaSyBIwzALxUPNbatRBj3Xi1Uhp0fFzwWNBkE
  </script>
  <script
    type="text/javascript"
    src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"
  ></script>
  <script type="text/javascript" src="map_data_1.js"></script>
  <script type="text/javascript" src="map_data_2.js"></script>
  <script type="text/javascript" src="map_data_3.js"></script>
  <script type="text/javascript" src="map_data_4.js"></script>
  <script type="text/javascript" src="map_data_5.js"></script>
  <script type="text/javascript" src="map_data_6.js"></script>
  <script type="text/javascript" src="map_data_7.js"></script>
  <script type="text/javascript" src="map_data_8.js"></script>
  <script type="text/javascript">
    function initialize() {
			$("#ex2").slider({});
      var center = new google.maps.LatLng(46.4545509, 30.7074861);
      var view_zone = { north: 46.7, south: 46.3, west: 30.5, east: 31 };
      var map = new google.maps.Map(document.getElementById("clustered-map"), {
        zoom: 1,
        center: center,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControl: false,
        restriction: { latLngBounds: view_zone },
        styles: [
          {
            featureType: "poi",
            elementType: "all",
            stylers: [{ visibility: "off" }],
          },
        ],
      });

      var map_data_wrapper = {
        "Департамент міського господарства": { data: map_data_1, on: true },
        "Управління капітального будівництва": { data: map_data_2, on: true },
        "Управління дорожного господарства": { data: map_data_3, on: true },
        "Органи місцевого самоврядування": { data: map_data_4, on: true },
        "Районні адміністрації": { data: map_data_5, on: true },
        "Департамент освіти": { data: map_data_6, on: true },
        "Депутатський фонд": { data: map_data_7, on: true },
        "Не використовується": { data: map_data_8, on: true },
      };

      //var infowindow = new google.maps.InfoWindow({pixelOffset:{height:0}}); // для отображения инфо окна прямо над обьектом при клике на нем
      var infowindow = new (function () {
        // для отображения инфы рядом с картой
        this.setContent = function (content) {
					if (content.length > 0) {
						content += '<button type="button" class="btn btn-success mt-4" data-toggle="modal" data-target="#exampleModalCenter">Подати заявку</button>';
						content += '<button type="button" class="btn btn-info ml-5 mt-4" data-toggle="modal" data-target="#exampleModalCenter2">Слідкувати за об\'єктом</button>';
					}

          document.getElementById("clustered-map-inner-info").innerHTML =
            content || "";
        };
        this.setPosition = function () {};
        this.open = function () {};
      })();
      function prepareInfoWindow(obj) {
        obj.addListener("click", (e) => {
          infowindow.setContent(obj.info);
          infowindow.setPosition(e.latLng);
          infowindow.open(map);
        });
      }

      var markerClusterer = new MarkerClusterer(map, [], {
        ignoreHidden: true,
        imagePath:
          "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",
      });

      function batchSetMap(arr, map) {
        var count = arr.length;
        for (var i = 0; i < count; i++) {
          arr[i].setMap(map);
        }
      }

      for (var layer_name in map_data_wrapper) {
        var layer = map_data_wrapper[layer_name];
        var markers_data = layer.data.markers;
        var styles = layer.data.styles;
        var markers = [];
        layer.markers = markers;
        var count = markers_data.length;
        for (var i = 0; i < count; i++) {
          var marker_data = markers_data[i];
          var marker = new google.maps.Marker({
            position: marker_data.position,
            info: marker_data.info,
            icon: styles[marker_data.style_name].marker_icon,
          });
          prepareInfoWindow(marker);
          markers.push(marker);
        }
        markerClusterer.addMarkers(layer.markers, true);

        var polylines_data = layer.data.polylines;
        var polylines = [];
        layer.polylines = polylines;
        var count = polylines_data.length;
        for (var i = 0; i < count; i++) {
          var polyline_data = polylines_data[i];
          var polyline = new google.maps.Polyline({
            path: polyline_data.path,
            info: polyline_data.info,
            strokeColor: styles[polyline_data.style_name].polyline_strokeColor,
            strokeWeight:
              styles[polyline_data.style_name].polyline_strokeWeight,
          });
          prepareInfoWindow(polyline);
          polylines.push(polyline);
        }
        batchSetMap(layer.polylines, map);

        var polygons_data = layer.data.polygons;
        var polygons = [];
        layer.polygons = polygons;
        var count = polygons_data.length;
        for (var i = 0; i < count; i++) {
          var polygon_data = polygons_data[i];
          var polygon = new google.maps.Polygon({
            paths: polygon_data.paths,
            info: polygon_data.info,
            strokeColor: styles[polygon_data.style_name].polygon_strokeColor,
            strokeWeight: styles[polygon_data.style_name].polygon_strokeWeight,
            fillColor: styles[polygon_data.style_name].polygon_fillColor,
            fillOpacity: styles[polygon_data.style_name].polygon_fillOpacity,
          });
          prepareInfoWindow(polygon);
          polygons.push(polygon);
        }
        batchSetMap(layer.polygons, map);
      }

      function batchSetVisiblity(arr, visiblity) {
        var count = arr.length;
        for (var i = 0; i < count; i++) {
          arr[i].setVisible(visiblity);
        }
      }

      function redrawMap() {
        for (var layer_name in map_data_wrapper) {
          var layer = map_data_wrapper[layer_name];
          batchSetVisiblity(layer.polylines, !!layer.on);
          batchSetVisiblity(layer.polygons, !!layer.on);
          batchSetVisiblity(layer.markers, !!layer.on);
        }
        markerClusterer.repaint();
      }

      function onZoomChange() {
        if (map.getZoom() >= 17) {
          markerClusterer.setGridSize(0);
        } else {
          markerClusterer.setGridSize(60);
        }
      }

      map.addListener("zoom_changed", onZoomChange);

      redrawMap();

      var legend = document.getElementById("clustered-map-legend");
      function legendCheckboxChange(e) {
        e = e || window.event;
        var target = e.target || e.srcElement;
        map_data_wrapper[target.parentNode.innerText].on = target.checked;
        redrawMap();
      }
      map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);
      for (var layer_name in map_data_wrapper) {
        var layer = map_data_wrapper[layer_name];
        legend.insertAdjacentHTML(
          "beforeend",
          "<label><input type='checkbox' " +
            (layer.on ? "checked" : "") +
            ">" +
            layer_name +
            "</label><br>"
        );
      }
      legend.querySelectorAll("input").forEach((elem) => {
        elem.onchange = legendCheckboxChange;
      });
    }

    google.maps.event.addDomListener(window, "load", initialize);
  </script>
</div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
  <script src="https://getbootstrap.com/docs/4.0/assets/js/vendor/popper.min.js"></script>
  <script src="https://getbootstrap.com/docs/4.0/dist/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js" integrity="sha512-f0VlzJbcEB6KiW8ZVtL+5HWPDyW1+nJEjguZ5IVnSQkvZbwBt2RfCBY0CBO1PsMAqxxrG4Di6TfsCPP3ZRwKpA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
